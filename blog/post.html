<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading... | Zeng Wei Blog</title>
  <meta name="description" content="Zeng Wei æŠ€æœ¯åšå®¢æ–‡ç« ">
  <meta name="author" content="Zeng Wei">

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ®</text></svg>">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Highlight.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark-dimmed.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <!-- KaTeX -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>

  <link rel="stylesheet" href="blog.css">
</head>
<body>

  <!-- Reading Progress Bar -->
  <div class="reading-progress" id="readingProgress"></div>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <a href="../index.html" class="nav-logo">ZW<span>.</span></a>
      <div class="nav-menu" id="navMenu">
        <a href="../index.html" class="nav-link">Home</a>
        <a href="../index.html#research" class="nav-link">Research</a>
        <a href="index.html" class="nav-link active">Blog</a>
      </div>
      <button class="nav-toggle" id="navToggle" aria-label="Toggle navigation">
        <i class="fas fa-bars"></i>
      </button>
    </div>
  </nav>

  <!-- Article Page -->
  <div class="article-page">
    <!-- Main Content -->
    <article class="article-main" id="articleMain">
      <div class="loading-skeleton" id="loadingState">
        <i class="fas fa-spinner fa-pulse"></i>
        <p>æ­£åœ¨åŠ è½½æ–‡ç« ...</p>
      </div>
    </article>

    <!-- Sidebar: TOC -->
    <aside class="article-sidebar" id="articleSidebar">
      <!-- TOC generated dynamically -->
    </aside>
  </div>

  <!-- Back to top -->
  <button class="back-to-top" id="backToTop" aria-label="Back to top">
    <i class="fas fa-arrow-up"></i>
  </button>

  <script>
  /**
   * Blog Article Renderer
   * Fetches markdown, renders with marked.js + highlight.js + KaTeX
   */
  document.addEventListener('DOMContentLoaded', async () => {

    // ---- Mobile menu toggle ----
    const navToggle = document.getElementById('navToggle');
    const navMenu = document.getElementById('navMenu');
    navToggle.addEventListener('click', () => {
      navMenu.classList.toggle('active');
      const icon = navToggle.querySelector('i');
      icon.classList.toggle('fa-bars');
      icon.classList.toggle('fa-times');
    });

    // ---- Back to top ----
    const backToTop = document.getElementById('backToTop');
    window.addEventListener('scroll', () => {
      backToTop.classList.toggle('visible', window.scrollY > 500);
    }, { passive: true });
    backToTop.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ---- Reading progress bar ----
    const progressBar = document.getElementById('readingProgress');
    window.addEventListener('scroll', () => {
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const scrollPos = window.scrollY;
      progressBar.style.width = docHeight > 0 ? (scrollPos / docHeight * 100) + '%' : '0%';
    }, { passive: true });

    // ---- Parse URL params ----
    const params = new URLSearchParams(window.location.search);
    const seriesId = params.get('s');
    const postId = params.get('p');

    if (!seriesId || !postId) {
      showError('å‚æ•°é”™è¯¯ï¼šç¼ºå°‘ç³»åˆ—æˆ–æ–‡ç«  ID');
      return;
    }

    // ---- Fetch metadata ----
    let postsData;
    try {
      const res = await fetch('posts.json');
      postsData = await res.json();
    } catch (e) {
      showError('æ— æ³•åŠ è½½æ–‡ç« å…ƒæ•°æ®');
      return;
    }

    const series = postsData.series.find(s => s.id === seriesId);
    if (!series) {
      showError('æœªæ‰¾åˆ°ç³»åˆ—ï¼š' + seriesId);
      return;
    }

    const articleIndex = series.articles.findIndex(a => a.id === postId);
    const article = series.articles[articleIndex];
    if (!article) {
      showError('æœªæ‰¾åˆ°æ–‡ç« ï¼š' + postId);
      return;
    }

    // ---- Update page title ----
    document.title = `${article.title} | Zeng Wei Blog`;

    // ---- Fetch markdown ----
    const mdPath = `posts/${seriesId}/${postId}.md`;
    let markdown;
    try {
      const res = await fetch(mdPath);
      if (!res.ok) throw new Error(res.statusText);
      markdown = await res.text();
    } catch (e) {
      showError('æ— æ³•åŠ è½½æ–‡ç« å†…å®¹ï¼š' + mdPath);
      return;
    }

    // ---- Configure marked ----
    marked.setOptions({
      gfm: true,
      breaks: false,
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      }
    });

    // ---- Protect math expressions from marked ----
    const mathBlocks = [];
    let mathIndex = 0;

    // Block math: $$...$$
    markdown = markdown.replace(/\$\$([\s\S]*?)\$\$/g, (match, math) => {
      const placeholder = `%%MATH_BLOCK_${mathIndex}%%`;
      mathBlocks.push({ placeholder, math: math.trim(), display: true });
      mathIndex++;
      return placeholder;
    });

    // Inline math: $...$  (not preceded by $ or followed by $)
    markdown = markdown.replace(/(?<!\$)\$(?!\$)((?:[^$\\]|\\.)+?)\$(?!\$)/g, (match, math) => {
      const placeholder = `%%MATH_INLINE_${mathIndex}%%`;
      mathBlocks.push({ placeholder, math: math.trim(), display: false });
      mathIndex++;
      return placeholder;
    });

    // ---- Render markdown ----
    let html = marked.parse(markdown);

    // ---- Restore and render math ----
    mathBlocks.forEach(({ placeholder, math, display }) => {
      try {
        const rendered = katex.renderToString(math, {
          displayMode: display,
          throwOnError: false,
          trust: true
        });
        html = html.replace(placeholder, rendered);
      } catch (e) {
        html = html.replace(placeholder, `<code>${math}</code>`);
      }
    });

    // ---- Extract title from first H1 (for breadcrumb, already in metadata) ----
    // We hide H1 via CSS since the title is in article-header

    // ---- Build article header ----
    const prevArticle = articleIndex > 0 ? series.articles[articleIndex - 1] : null;
    const nextArticle = articleIndex < series.articles.length - 1 ? series.articles[articleIndex + 1] : null;

    // Estimate reading time (Chinese ~400 chars/min for technical content)
    const charCount = markdown.replace(/[#*`\[\]()!|>\-\n\r\s]/g, '').length;
    const readingTime = Math.max(1, Math.ceil(charCount / 400));

    const articleHTML = `
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href="index.html"><i class="fas fa-home"></i> åšå®¢</a>
        <span class="sep"><i class="fas fa-chevron-right"></i></span>
        <a href="index.html#${seriesId}">${series.title}</a>
        <span class="sep"><i class="fas fa-chevron-right"></i></span>
        <span class="current">${article.title}</span>
      </nav>

      <!-- Article Header -->
      <header class="article-header">
        <div class="article-series-badge" data-series="${seriesId}">
          <i class="fas ${series.icon}"></i>
          ${series.title} Â· ${parseInt(article.id)}/${series.articles.length}
        </div>
        <h1>${article.title}</h1>
        <div class="article-meta">
          <span class="article-meta-item">
            <i class="fas fa-calendar"></i> ${article.date}
          </span>
          <span class="article-meta-item">
            <i class="fas fa-clock"></i> ${readingTime} åˆ†é’Ÿé˜…è¯»
          </span>
          <span class="article-meta-item">
            <i class="fas fa-book"></i> ${series.title}
          </span>
        </div>
        ${article.tags ? `
        <div class="article-tags">
          ${article.tags.map(t => `<span class="article-tag">${t}</span>`).join('')}
        </div>
        ` : ''}
      </header>

      <!-- Article Content -->
      <div class="markdown-body">
        ${html}
      </div>

      <!-- Series Navigation -->
      <nav class="series-nav">
        ${prevArticle ? `
        <a href="post.html?s=${seriesId}&p=${prevArticle.id}" class="series-nav-item prev">
          <span class="series-nav-label"><i class="fas fa-arrow-left"></i> ä¸Šä¸€ç¯‡</span>
          <span class="series-nav-title">${prevArticle.title}</span>
        </a>
        ` : '<div class="series-nav-placeholder"></div>'}
        ${nextArticle ? `
        <a href="post.html?s=${seriesId}&p=${nextArticle.id}" class="series-nav-item next">
          <span class="series-nav-label">ä¸‹ä¸€ç¯‡ <i class="fas fa-arrow-right"></i></span>
          <span class="series-nav-title">${nextArticle.title}</span>
        </a>
        ` : '<div class="series-nav-placeholder"></div>'}
      </nav>
    `;

    // ---- Inject content ----
    const articleMain = document.getElementById('articleMain');
    articleMain.innerHTML = articleHTML;

    // ---- Apply highlight.js to any remaining code blocks ----
    document.querySelectorAll('.markdown-body pre code').forEach(block => {
      if (!block.dataset.highlighted) {
        hljs.highlightElement(block);
      }
    });

    // ---- Generate TOC ----
    generateTOC();

    // ---- Scroll-spy for TOC ----
    setupScrollSpy();
  });

  // ---- Generate Table of Contents ----
  function generateTOC() {
    const sidebar = document.getElementById('articleSidebar');
    const headings = document.querySelectorAll('.markdown-body h2, .markdown-body h3');

    if (headings.length === 0) {
      sidebar.style.display = 'none';
      return;
    }

    // Assign IDs to headings
    const tocItems = [];
    headings.forEach((h, i) => {
      const id = 'heading-' + i;
      h.id = id;
      tocItems.push({
        id: id,
        text: h.textContent,
        level: h.tagName.toLowerCase()
      });
    });

    const tocHTML = `
      <div class="toc-container">
        <div class="toc-title"><i class="fas fa-list"></i> ç›®å½•</div>
        <ul class="toc-list">
          ${tocItems.map(item => `
            <li>
              <a href="#${item.id}" class="toc-${item.level}">${item.text}</a>
            </li>
          `).join('')}
        </ul>
      </div>
    `;
    sidebar.innerHTML = tocHTML;
  }

  // ---- Scroll Spy for TOC ----
  function setupScrollSpy() {
    const tocLinks = document.querySelectorAll('.toc-list a');
    if (tocLinks.length === 0) return;

    const headings = Array.from(document.querySelectorAll('.markdown-body h2, .markdown-body h3'));

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          tocLinks.forEach(link => link.classList.remove('active'));
          const activeLink = document.querySelector(`.toc-list a[href="#${entry.target.id}"]`);
          if (activeLink) {
            activeLink.classList.add('active');
            // Scroll TOC to keep active item visible
            activeLink.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
          }
        }
      });
    }, {
      rootMargin: '-80px 0px -60% 0px',
      threshold: 0
    });

    headings.forEach(h => observer.observe(h));
  }

  // ---- Show error ----
  function showError(msg) {
    document.getElementById('articleMain').innerHTML = `
      <div class="loading-skeleton">
        <i class="fas fa-exclamation-triangle" style="color: var(--rose);"></i>
        <p>${msg}</p>
        <p style="margin-top: 12px;"><a href="index.html">â† è¿”å›åšå®¢é¦–é¡µ</a></p>
      </div>
    `;
  }
  </script>
</body>
</html>
