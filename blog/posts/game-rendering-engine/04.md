# 全局光照的圣杯之战：从光线追踪到 Lumen

> 全局光照（Global Illumination）是实时渲染领域最具挑战性的问题，也是区分"游戏画面"和"电影画面"的关键因素。本文全面梳理 GI 技术从烘焙到实时的完整演进。

## 引言：那束被遗忘的"间接光"

观察你身边的真实场景——即使没有直接被灯光照射的角落，也不是完全黑暗的。这是因为光线在反射后还会继续传播，照亮其他表面。这种**间接光照**就是全局光照的核心。

在游戏渲染中，仅计算直接光照（光源直接照射到物体表面）是远远不够的。缺少间接光照的场景看起来"假"、"硬"、"平"——阴影处纯黑，缺乏柔和的色彩过渡。

**全局光照 = 直接光照 + 间接光照（一次弹射 + 二次弹射 + ...）**

精确求解全局光照需要在渲染方程中进行多次弹射的积分计算，这在计算上极为昂贵。三十年来，工程师们一直在寻找"足够好"的近似方案——这就是全局光照的"圣杯之战"。

---

## 技术全景图

```
全局光照技术
├── 离线/预计算方案
│   ├── 光照贴图烘焙（Lightmap Baking）
│   ├── 辐照度体积（Irradiance Volumes）
│   └── 光照探针（Light Probes）
├── 屏幕空间方案
│   ├── SSAO（屏幕空间环境遮蔽）
│   ├── SSGI（屏幕空间全局光照）
│   └── SSR（屏幕空间反射）
├── 基于体素/SDF 的方案
│   ├── VXGI（体素锥追踪）
│   ├── SDF Tracing（有符号距离场追踪）
│   └── Lumen（UE5 混合方案）
└── 硬件光线追踪方案
    ├── RTGI（光追全局光照）
    ├── 混合渲染（光栅化 + 光追）
    └── 全路径追踪（Path Tracing）
```

---

## 第一代：预计算/烘焙方案

### 光照贴图烘焙（Lightmap Baking）

最经典的 GI 方案——在开发阶段用离线渲染器计算全局光照，将结果"烘焙"到纹理上。

```
工作流：
1. 美术师布置好场景和光源
2. 离线渲染器运行数分钟到数小时
3. 将每个表面的光照结果存储为纹理（Lightmap）
4. 运行时直接读取纹理，几乎零开销
```

**优点**：
- 画质极高（可以用路径追踪来烘焙）
- 运行时开销几乎为零
- 支持无限次弹射

**缺点**：
- **完全静态**——光源和物体不能移动
- 烘焙时间长（大型场景可能需要数小时）
- 占用大量纹理内存
- 迭代效率低（改一个灯的位置就要重新烘焙）

Unity 的 Progressive Lightmapper 和 UE4 的 Lightmass 是代表性实现。至今仍被大量手游和独立游戏使用。

### 光照探针（Light Probes）

为了给**动态物体**提供间接光照（烘焙方案只能处理静态表面），光照探针应运而生。

原理：在场景中放置一组采样点，每个点存储一个**球谐函数（Spherical Harmonics, SH）** 表示的辐照度场。

$$L(\mathbf{n}) \approx \sum_{l=0}^{L} \sum_{m=-l}^{l} c_{lm} \cdot Y_{lm}(\mathbf{n})$$

动态物体根据其位置，插值附近探针的 SH 系数来获得间接光照。

通常使用 **2 阶或 3 阶球谐函数**（4 或 9 个系数），精度有限但足以表达低频的环境光照。

---

## 第二代：屏幕空间方案

### SSAO（Screen-Space Ambient Occlusion）

2007 年 Crytek 在《Crysis》中首创的技术——在屏幕空间中近似计算环境遮蔽。

原理：对每个像素，在其周围半球内随机采样，检查有多少采样点被其他几何体遮挡。遮挡比例越高，该像素越暗。

```
SSAO 的进化：
SSAO（Crytek, 2007）→ HBAO（NVIDIA, 2008）→ GTAO（Activision, 2016）
                                                    ↑ 现代引擎主流
```

**GTAO（Ground Truth AO）** 通过巧妙的数学推导，在保持实时性能的同时，比原始 SSAO 精确得多。

### SSGI（Screen-Space Global Illumination）

在 SSAO 的基础上更进一步——不只判断遮挡，还考虑被遮挡表面的颜色对当前像素的间接光照贡献。

例如：红色墙壁反射的光照亮附近的白色地板，使其呈现微微的红色调——这就是**Color Bleeding（颜色渗透）**。

**局限**：所有屏幕空间方案共享一个根本限制——**只能看到屏幕上可见的信息**。屏幕外的物体、被遮挡的物体，统统无法参与计算。

---

## 第三代：基于体素/SDF 的方案

### VXGI（Voxel Cone Tracing）

NVIDIA 提出的方案——将场景体素化（存入 3D 纹理），然后从每个像素向外发射锥形射线，在体素网格中追踪间接光照。

```
1. 将场景几何体素化为 3D 纹理（多级 Mipmap）
2. 从每个像素的法线方向发射多个锥（Cone）
3. 在体素 Mipmap 中追踪：近处采样细级别，远处采样粗级别
4. 累积沿途的颜色和遮挡
```

**优点**：全动态、支持一次弹射间接光照
**缺点**：体素化开销大、内存消耗高、容易出现闪烁

### SDF Tracing（有符号距离场追踪）

UE5 的 Lumen 大量使用了这种技术。**SDF（Signed Distance Field）** 为场景中的每个物体存储一个 3D 距离场，表示空间中每个点到最近表面的距离。

SDF 的妙处在于：**追踪射线时，可以安全地跳过一大段空白空间**。

```
传统光线步进（Ray Marching）：
  每次前进固定小步 → 大量无用计算
  
SDF 加速的光线步进：
  每次前进 = 当前SDF值（到最近表面的距离）→ 大步跳过空白区域
```

这使得在 GPU 上进行大量射线追踪变得可行，而不需要专用的 RT Core 硬件。

---

## UE5 Lumen：混合方案的集大成者

**Lumen** 是虚幻引擎 5 的全局光照和反射系统，也是目前工业界最先进的实时 GI 方案之一。它不依赖单一技术，而是**混合多种追踪方案**。

### Lumen 的三层追踪策略

```
Layer 1: 屏幕空间追踪（Screen Trace）
  → 成本最低，处理屏幕上可见的近距离 GI
  → 利用 Hi-Z 进行加速

Layer 2: 网格 SDF 追踪（Mesh Distance Field Trace）
  → 中等成本，处理近距离但屏幕外的 GI
  → 每个物体的 SDF 组成全局距离场

Layer 3: 全局 SDF + 体素光照追踪
  → 处理远距离 GI
  → 使用低分辨率的全局 SDF + 辐照度缓存

[可选] Layer 4: 硬件光线追踪
  → 在支持 RT Core 的硬件上替代/增强 SDF 追踪
  → 提供更精确的几何交叉测试
```

### Lumen 的数据结构

Lumen 使用多种数据结构来高效存储和查询光照信息：

- **Surface Cache**：将场景表面参数化为一组低分辨率的"卡片"（Card），存储每个表面的材质信息
- **Radiance Cache**：世界空间中的辐照度缓存，使用八叉树组织
- **Screen Probe**：屏幕空间的辐照度探针网格

### Lumen vs 传统烘焙

| 特性 | Lightmap 烘焙 | Lumen |
|------|-------------|-------|
| 动态光源 | 不支持 | 完全支持 |
| 动态物体 GI | 仅 Light Probe | 完全支持 |
| 美术迭代速度 | 慢（需重新烘焙） | 即时反馈 |
| 画质上限 | 极高（离线渲染） | 高（实时近似） |
| 运行时开销 | 几乎为零 | 较高（3-5ms/帧） |
| 适用平台 | 所有平台 | 中高端 PC/主机 |

---

## 硬件光线追踪（Hardware RT）

### 光线追踪的基本原理

光线追踪的核心思想非常直观：**从摄像机发射光线，追踪其与场景的交互**。

```
对每个像素：
  1. 从摄像机发射一条主射线
  2. 找到最近的交点
  3. 在交点处：
     a. 计算直接光照（向光源发射阴影射线）
     b. 根据材质发射反射/折射射线（递归）
     c. 发射漫反射射线收集间接光照
  4. 累加所有光照贡献
```

### 加速结构：BVH

暴力检测射线与每个三角形的交点是不可行的（百万三角形 × 百万像素）。**BVH（Bounding Volume Hierarchy）** 使用层次化的包围盒来加速交叉测试：

```
BVH 树：
  根节点（包围整个场景的大盒子）
  ├── 左子树（包围左半场景）
  │   ├── ...
  │   └── 叶节点（包含少量三角形）
  └── 右子树（包围右半场景）
      ├── ...
      └── 叶节点
```

射线先与大盒子测试——如果不相交，整个子树都可以跳过。**NVIDIA 的 RT Core 就是在硬件层面加速 BVH 遍历和射线-三角形交叉测试。**

### 降噪：从噪点到清晰

实时光追的一个核心挑战是**采样数不足**。路径追踪需要每像素数千条射线才能收敛，但实时只能发射 1-4 条。结果就是——大量噪点。

**时空降噪器（Spatio-Temporal Denoiser）** 是关键：
- **时间复用（Temporal Accumulation）**：复用前几帧的结果，相当于增加了有效采样数
- **空间滤波（Spatial Filter）**：利用几何信息引导的模糊来消除噪点
- **AI 降噪（如 NVIDIA OptiX Denoiser）**：用神经网络学习从噪点图到干净图的映射

### 混合渲染 vs 全路径追踪

**混合渲染**（当前主流）：
```
不透明物体几何 → 光栅化（快速）
阴影          → 光线追踪（精确软阴影）
反射          → 光线追踪（精确反射）
GI            → 光线追踪/Lumen（一次弹射）
```

**全路径追踪**（未来趋势）：
```
所有光照效果 → 统一用路径追踪计算
  → 阴影、反射、GI、焦散 全部自然产生
  → 无需针对每种效果单独开发算法
```

《赛博朋克2077 Overdrive》是全路径追踪的里程碑——但需要 RTX 4070 以上 + DLSS 3 才能流畅运行。

---

## 各大公司的 GI 方案对比

| 公司/引擎 | GI 方案 | 特点 |
|-----------|---------|------|
| **Epic / UE5** | Lumen | SDF + Screen Trace + 可选 HW RT |
| **Unity 6** | APV (Adaptive Probe Volumes) + Screen-Space GI | 探针网格 + SSGI |
| **DICE / Frostbite** | DDGI (Dynamic Diffuse GI) | 基于光线追踪的探针更新 |
| **id Software / id Tech 7** | 预计算辐照度 + RT 反射 | 简洁高效 |
| **CD Projekt / REDengine** | 全路径追踪 (Overdrive) | 业界最激进的方案 |
| **Guerrilla / Decima** | 预计算 Light Probe + SSR | 效率导向 |
| **Naughty Dog** | 混合烘焙 + 实时探针 | PS5 优化极致 |

---

## 小结：GI 技术的选择矩阵

| 需求 | 推荐方案 | 原因 |
|------|---------|------|
| 手游 / 低端设备 | 烘焙 Lightmap + Light Probe | 运行时零开销 |
| 中端 PC / 主机 | Lumen（软件模式） | 全动态、无需烘焙 |
| 高端 PC（有 RT Core） | Lumen（HW RT 模式）或 RTGI | 更高精度 |
| 追求极致画质 | 全路径追踪 + DLSS/FSR | 物理精确，需顶级硬件 |

全局光照仍然是实时渲染中最"贵"的计算之一。但从预计算到全动态、从粗糙近似到物理精确，三十年的进步已经让"电影级 GI"走进了实时游戏。

---

*上一篇：[材质与光照的科学：PBR 如何统一了游戏画面](./03-材质与光照的科学：PBR如何统一了游戏画面.md)*

*下一篇：[万亿多边形的秘密：Nanite 与虚拟几何体革命](./05-万亿多边形的秘密：Nanite与虚拟几何体革命.md)*
