# 材质与光照的科学：PBR 如何统一了游戏画面

> 为什么 2012 年以后的游戏画面突然看起来"统一"了？答案是 PBR（基于物理的渲染）。本文从微面元理论出发，深入讲解 PBR 的数学基础和工业实践。

## 引言：一个材质，到处正确

在 PBR 之前的时代，游戏美术师面临一个令人抓狂的问题：

> 在室内调好的金属材质，拿到室外就变得不对劲；白天看着合理的皮肤着色，在火把光照下就变成了塑料。

根本原因是，早期的着色模型（如 Phong、Blinn-Phong）是**经验式的**——它们用一些"看起来差不多"的数学公式模拟光照效果，但并不遵循物理定律。

**PBR（Physically-Based Rendering）** 的核心承诺是：

> **同一套材质参数，在任何光照条件下都能产生物理正确的视觉效果。**

这不仅提升了画面质量，更极大地提高了美术生产效率——材质一次制作，处处可用。

---

## 一切的基础：渲染方程

1986 年，Jim Kajiya 提出了著名的**渲染方程（Rendering Equation）**。这是整个计算机图形学的理论基石：

$$L_o(\mathbf{p}, \omega_o) = L_e(\mathbf{p}, \omega_o) + \int_{\Omega} f_r(\mathbf{p}, \omega_i, \omega_o) \cdot L_i(\mathbf{p}, \omega_i) \cdot (\omega_i \cdot \mathbf{n}) \, d\omega_i$$

翻译成人话：

> **某个点向某个方向射出的光 = 该点自身发出的光 + 从所有方向接收到的光经过材质反射后向该方向射出的部分**

其中：
- $L_o$ — 出射光辐射度（我们最终看到的）
- $L_e$ — 自发光（如 LED 屏幕、火焰）
- $f_r$ — **BRDF**（双向反射分布函数）—— 这就是"材质"的数学定义
- $L_i$ — 入射光辐射度
- $\omega_i \cdot \mathbf{n}$ — 入射角的余弦项（Lambert 余弦定律）
- $\Omega$ — 半球积分域

**PBR 的本质就是：在实时渲染中，尽可能精确地求解这个方程。**

---

## BRDF：材质的数学身份证

**BRDF（Bidirectional Reflectance Distribution Function）** 描述了光线如何从一个方向入射后，向另一个方向反射。它是定义材质外观的核心函数。

### BRDF 的物理约束

一个物理合理的 BRDF 必须满足两条基本定律：

1. **能量守恒**：反射出去的光不能超过入射的光

$$\int_{\Omega} f_r(\omega_i, \omega_o) \cdot (\omega_o \cdot \mathbf{n}) \, d\omega_o \leq 1$$

2. **亥姆霍兹互反性**：交换入射和出射方向，BRDF 值不变

$$f_r(\omega_i, \omega_o) = f_r(\omega_o, \omega_i)$$

### BRDF 的进化史

| 模型 | 年代 | 特点 |
|------|------|------|
| **Lambert** | 1760 | 纯漫反射，各方向均匀 |
| **Phong** | 1975 | 加入经验式高光，但不能量守恒 |
| **Blinn-Phong** | 1977 | 用半程向量优化 Phong |
| **Cook-Torrance** | 1982 | 基于微面元理论的物理模型 |
| **GGX/Trowbridge-Reitz** | 2007 | 改进的法线分布函数，长尾高光 |
| **Disney Principled BRDF** | 2012 | 美术友好的参数化，统一所有材质 |

---

## 微面元理论：金属为什么闪闪发光？

**微面元理论（Microfacet Theory）** 是现代 PBR 的理论基础。核心假设是：

> **任何看似平滑的表面，在微观尺度上都由无数微小的完美镜面组成。**

每个微面元（Microfacet）都是一个完美的平面镜，只在特定方向上反射光线。材质的宏观外观由这些微面元的**统计分布**决定。

```
粗糙表面：微面元方向随机分散 → 光线向多个方向反射 → 模糊、柔和的高光
光滑表面：微面元方向高度一致 → 光线集中反射      → 尖锐、明亮的高光
```

### Cook-Torrance 镜面 BRDF

游戏中使用最广泛的 PBR 镜面反射公式：

$$f_{\text{spec}}(\omega_i, \omega_o) = \frac{D(\mathbf{h}) \cdot F(\omega_i, \mathbf{h}) \cdot G(\omega_i, \omega_o)}{4 \cdot (\omega_i \cdot \mathbf{n}) \cdot (\omega_o \cdot \mathbf{n})}$$

三个核心函数各有分工：

#### D — 法线分布函数（Normal Distribution Function）

描述微面元法线的统计分布。工业标准是 **GGX（Trowbridge-Reitz）** 分布：

$$D_{\text{GGX}}(\mathbf{h}) = \frac{\alpha^2}{\pi \cdot \left((\mathbf{n} \cdot \mathbf{h})^2 \cdot (\alpha^2 - 1) + 1\right)^2}$$

其中 $\alpha = \text{roughness}^2$。

GGX 的特点是**长尾分布**——高光边缘有柔和的渐变，比 Phong/Beckmann 更接近真实材质。

#### F — 菲涅尔方程（Fresnel Equation）

描述光在不同角度入射时的反射率变化。**Schlick 近似**是工业标准：

$$F_{\text{Schlick}}(\theta) = F_0 + (1 - F_0) \cdot (1 - \cos\theta)^5$$

其中 $F_0$ 是法线方向的基础反射率。

这个公式揭示了一个重要的物理现象：**任何材质在掠射角（接近平行观察）时都趋向完全反射**。这就是为什么湖面在远处看起来像镜子，而脚下的水是透明的。

#### G — 几何遮蔽函数（Geometry Function）

描述微面元之间的自遮挡效应。工业标准是 **Smith-GGX**：

$$G(\omega_i, \omega_o) = G_1(\omega_i) \cdot G_1(\omega_o)$$

$$G_1(\omega) = \frac{(\mathbf{n} \cdot \omega)}{(\mathbf{n} \cdot \omega) \cdot (1 - k) + k}, \quad k = \frac{(\alpha + 1)^2}{8}$$

---

## Disney Principled BRDF：美术师的福音

2012 年，迪士尼动画工作室发表了一篇改变行业的论文——**"Physically Based Shading at Disney"**。

核心贡献不是新的数学模型，而是**用直觉化的参数取代了晦涩的物理量**：

| 参数 | 范围 | 直觉含义 |
|------|------|---------|
| **baseColor** | RGB | 材质的基本颜色 |
| **metallic** | 0–1 | 0 = 非金属，1 = 金属 |
| **roughness** | 0–1 | 0 = 完美镜面，1 = 完全粗糙 |
| **specular** | 0–1 | 非金属的菲涅尔强度 |
| **subsurface** | 0–1 | 次表面散射强度（皮肤、蜡） |
| **anisotropic** | 0–1 | 各向异性程度（拉丝金属） |
| **sheen** | 0–1 | 织物边缘光泽（天鹅绒） |
| **clearcoat** | 0–1 | 清漆层强度（车漆、瓷器） |
| **clearcoatGloss** | 0–1 | 清漆层光泽度 |

### 金属-非金属工作流（Metal/Roughness Workflow）

游戏行业广泛采用的简化版 Disney BRDF 使用**金属度-粗糙度**工作流：

```
非金属（metallic = 0）：
  • 漫反射：baseColor 决定
  • 高光反射：F0 ≈ 0.04（几乎所有非金属都接近这个值）
  
金属（metallic = 1）：
  • 漫反射：无（金属吸收所有折射光）
  • 高光反射：F0 = baseColor（反射光带有金属色调）
```

这意味着美术师只需要制作**三张纹理贴图**就能定义绝大多数材质：
1. **基色贴图（Albedo Map）**
2. **粗糙度贴图（Roughness Map）**
3. **金属度贴图（Metallic Map）**

配合法线贴图（Normal Map）和环境光遮蔽贴图（AO Map），这就是现代游戏中最常见的 **PBR 纹理套件**。

---

## 图像基光照（IBL）：让环境"活"起来

仅有直接光照（太阳、灯泡）是不够的。现实世界中，物体还受到来自四面八方的**环境光照**——天空、地面反射、墙壁间接光等。

**IBL（Image-Based Lighting）** 用一张环境贴图（通常是 HDR Cubemap）来近似这些环境光照：

### 漫反射 IBL

预计算所有方向的环境光对漫反射的贡献：

$$L_{\text{diffuse}} = \frac{\text{baseColor}}{\pi} \cdot \int_{\Omega} L_i(\omega_i) \cdot (\omega_i \cdot \mathbf{n}) \, d\omega_i$$

这个积分可以预计算为一张**辐照度贴图（Irradiance Map）**——对每个法线方向存储积分结果。

### 镜面 IBL（Split-Sum 近似）

Epic Games 提出的**Split-Sum Approximation**将镜面积分拆成两部分：

$$L_{\text{spec}} \approx \left(\int_\Omega L_i(\omega_i) D(\mathbf{h}) d\omega_i\right) \cdot \left(\int_\Omega f_r \cdot (\omega_i \cdot \mathbf{n}) d\omega_i\right)$$

- 第一部分 → **预过滤环境贴图（Pre-filtered Env Map）**：按不同粗糙度等级模糊
- 第二部分 → **BRDF 积分查找表（BRDF LUT）**：一张 2D 纹理

这使得镜面 IBL 可以实时计算，是 PBR 管线中的关键技术。

---

## PBR 在工业界的应用

### 各大引擎的 PBR 实现

| 引擎 | PBR 模型 | 特色 |
|------|---------|------|
| **Unreal Engine 5** | Cook-Torrance + GGX | Lumen 全局光照集成、Substrate 材质系统 |
| **Unity HDRP** | Cook-Torrance + GGX | Lit Shader 标准模型、AxF 工业材质支持 |
| **Frostbite（EA）** | Cook-Torrance + GGX | 多散射补偿、布料着色 |
| **id Tech 7** | 简化 PBR | Megatexture + 虚拟纹理 |
| **Decima（Guerrilla）** | Cook-Torrance | 头发、皮肤专用 BSDF |

### 材质扫描与数字资产

PBR 材质的一个重要优势是可以通过**材质扫描**直接获取真实世界的材质参数：

1. 用专业设备（如 X-Rite TAC7）拍摄材质在不同光照角度下的照片
2. 通过拟合算法反推 PBR 参数（基色、粗糙度、法线）
3. 直接导入游戏引擎使用

Quixel Megascans（现为 Epic 所有）和 Adobe Substance 3D 提供了海量的扫描 PBR 材质库，大幅加速了游戏开发流程。

---

## 超越标准 PBR：特殊材质

标准的 Cook-Torrance 模型假设光在表面直接反射，但很多材质需要更复杂的光传输模型：

### 次表面散射（SSS / Subsurface Scattering）

光线穿透表面、在内部散射后从其他位置射出——这是**皮肤、蜡、玉石、牛奶**等半透明材质的特征。

现代实现方式：
- **屏幕空间 SSS**：在屏幕空间用可分离的高斯核模糊漫反射
- **预积分 SSS 查找表**：基于曲率预计算散射效果
- **随机采样路径追踪**：最精确但最昂贵（《最后的生还者 Part II》的皮肤）

### 布料着色（Cloth Shading）

织物的微观结构完全不同于固体表面——纤维形成的复杂结构需要专用的着色模型：
- **Ashikhmin 各向异性 BRDF**：模拟丝绸的方向性光泽
- **Charlie Sheen 模型**：模拟天鹅绒、毛绒等柔软织物

### 毛发渲染（Hair / Fur）

头发需要沿纤维方向的各向异性反射模型：
- **Marschner 模型**：R（反射）+ TT（透射-透射）+ TRT（透射-反射-透射）三路径
- UE5 的头发着色器：基于 Marschner 的简化实时版本

### 眼球渲染

真实感眼球需要多层结构：
- 角膜层（透明、高反射）
- 虹膜层（纹理细节 + 焦散）
- 折射效应（角膜折射改变虹膜可见角度）

《黑神话：悟空》和 Unreal 的数字人类（MetaHuman）在这方面达到了极高的水准。

---

## 小结

| 概念 | 核心思想 |
|------|---------|
| **渲染方程** | 所有渲染的统一理论基础 |
| **BRDF** | 材质的数学定义——光如何被反射 |
| **微面元理论** | 粗糙表面 = 大量微小镜面的统计效果 |
| **Cook-Torrance** | D·F·G 三项的乘积——工业标准镜面 BRDF |
| **Disney Principled** | 美术友好的参数化——metallic + roughness 工作流 |
| **IBL + Split-Sum** | 实时环境光照的关键近似技术 |
| **能量守恒** | PBR 的物理基石——反射光不超过入射光 |

PBR 不仅仅是一种技术——它是一套**统一的材质语言**。从 2014 年至今，几乎所有 3A 游戏都在使用 PBR。它让游戏画面进入了一个"一致性"的新时代：任何材质、任何光照、任何环境，画面都是物理正确的。

---

*上一篇：[实时渲染管线全解析：一帧画面的诞生之旅](./02-实时渲染管线全解析：一帧画面的诞生之旅.md)*

*下一篇：[全局光照的圣杯之战：从光线追踪到 Lumen](./04-全局光照的圣杯之战：从光线追踪到Lumen.md)*
